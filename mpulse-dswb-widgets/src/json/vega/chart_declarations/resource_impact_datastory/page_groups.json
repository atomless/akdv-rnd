{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 800,
  "height": 0,
  "padding": 0,
  "data": [
    {
      "url": "https://localhost:3000/2.2.5/data/resource_impact_datastory.json",
      "name": "chart_data"
    },
    {
      "name": "page_group_data",
      "source": "chart_data",
      "transform": [
        {
          "type": "flatten",
          "fields": [
            "charts.0.data"
          ],
          "as": [
            "data"
          ]
        },
        {
          "type": "project",
          "fields": [
            "data.Page Group",
            "data.Included",
            "data.Requests",
            "data.page_timer",
            "data.Ranked Correlation",
            "data.Relative Conversion Impact Score",
            "data.Proportion"
          ],
          "as": [
            "page_group",
            "included",
            "requests",
            "page_timer",
            "ranked_correlation",
            "relative_conversion_impact_score",
            "proportion"
          ]
        }
      ]
    },
    {
      "name": "page_group_page_timer_data",
      "source": "page_group_data",
      "transform": [
        {
          "type": "extent",
          "field": "page_timer",
          "signal": "page_group_page_timer_extent_signal"
        }
      ]
    }
  ],
  "signals": [
    {
      "name": "width",
      "update": "width"
    },
    {
      "name": "height",
      "update": "(bandwidth('page_group_impact_label_scale') * 1.276) * length(domain('page_group_impact_label_scale'))"
    },
    {
      "name": "axes_label_color",
      "value": "hsl(205, 60%, 45%)"
    },
    {
      "name": "axes_tick_text_color",
      "value": "hsl(205, 35%, 45%)"
    },
    {
      "name": "tooltip",
      "value": {},
      "on": [
        {
          "events": "rect:mouseover",
          "update": "datum"
        },
        {
          "events": "rect:mouseout",
          "update": "{}"
        }
      ]
    }
  ],
  "scales": [
    {
      "name": "page_group_impact_scale",
      "type": "linear",
      "reverse": true,
      "domain": {
        "data": "page_group_data",
        "field": "relative_conversion_impact_score"
      },
      "range": "width",
      "padding": 0.05,
      "round": true
    },
    {
      "name": "page_group_impact_label_scale",
      "type": "band",
      "domain": [
        "Less Impact",
        "More Impact"
      ],
      "range": "width"
    },
    {
      "name": "page_group_page_timer_scale",
      "type": "linear",
      "reverse": true,
      "domain": {
        "data": "page_group_data",
        "field": "page_timer"
      },
      "domainMin": 0,
      "domainMax": {
        "signal": "page_group_page_timer_extent_signal[1] + 750"
      },
      "range": {
        "scheme": "spectral"
      }
    },
    {
      "name": "page_group_scale",
      "type": "band",
      "domain": {
        "data": "page_group_data",
        "field": "page_group"
      },
      "range": {
        "step": 60
      },
      "paddingInner": 0.05
    },
    {
      "name": "page_group_load_time_scale",
      "type": "linear",
      "reverse": false,
      "domain": {
        "data": "page_group_data",
        "field": "page_timer"
      },
      "domainMin": 0,
      "domainMax": {
        "signal": "page_group_page_timer_extent_signal[1] + 500"
      },
      "range": "width",
      "padding": 0
    }
  ],
  "axes": [
    {
      "orient": "top",
      "scale": "page_group_impact_label_scale",
      "labelFontSize": 14,
      "labelFontWeight": "300",
      "labelFont":"lato",
      "labelColor": { "signal": "axes_tick_text_color"},
      "encode": {
        "labels": {
          "interactive": true,
          "update": {
            "tooltip": {
              "signal": "data('page_group_data')[0].page_timer"
            }
          }
        }
      }
    },
    {
      "orient": "left",
      "scale": "page_group_scale",
      "labelFontSize": 13,
      "labelFontWeight": "300",
      "labelFont":"lato",
      "labelColor": { "signal": "axes_tick_text_color"},
      "title": "Page Groups (ordered by Activity)",
      "titleFontSize": 16,
      "titleFont":"lato",
      "titleColor": { "signal": "axes_label_color"}
    }
  ],
  "legends": [
    {
      "orient": "bottom",
      "fill": "page_group_page_timer_scale",
      "offset": 0,
      "padding": 0,
      "direction": "horizontal",
      "gradientLength": {
        "signal": "width"
      },
      "gradientThickness": 15,
      "title": "Load Time (ms)",
      "titleFontSize": 15,
      "titleFont":"lato",
      "titleAnchor": "middle",
      "titleOrient": "bottom",
      "titlePadding": 15,
      "titleColor": { "signal": "axes_label_color"}
    }
  ],
  "marks": [
    {
      "name": "page_group_bar_mark",
      "type": "rect",
      "from": {
        "data": "page_group_data"
      },
      "encode": {
        "enter": {
          "y": {
            "scale": "page_group_scale",
            "field": "page_group"
          },
          "height": {
            "scale": "page_group_scale",
            "band": 1
          },
          "x": {
            "scale": "page_group_impact_scale",
            "field": "relative_conversion_impact_score"
          },
          "x2": {
            "scale": "page_group_impact_scale",
            "value": 0
          }
        },
        "update": {
          "fill": {
            "value": "hsl(205, 45%, 48%)"
          },
          "tooltip": {
            "signal": "scale('page_group_impact_label_scale',datum.relative_conversion_impact_score)"
          }
        },
        "hover": {
          "fill": {
            "value": "hsl(205, 45%, 60%)"
          }
        }
      }
    },
    {
      "name": "page_group_load_time_mark",
      "type": "rect",
      "from": {
        "data": "page_group_data"
      },
      "encode": {
        "enter": {
          "yc": {
            "signal": "scale('page_group_scale',datum.page_group) + (bandwidth('page_group_scale') * 0.5)"
          },
          "height": {
            "scale": "page_group_scale",
            "band": 0.8
          },
          "width": {
            "value": 9
          },
          "cornerRadius": {
            "value": 5
          },
          "fill": {
            "scale": "page_group_page_timer_scale",
            "field": "page_timer"
          },
          "tooltip": {
            "signal": "scale('page_group_load_time_scale',datum.page_timer)"
          },
          "stroke": {
            "color": {
              "h": {"signal": "hsl(item.fill).h"},
              "s": {"signal": "hsl(item.fill).s * 1.3"},
              "l": {"signal": "hsl(item.fill).l - 0.4"}
            }
          },
          "strokeWidth": {
            "value": 1
          }
        },
        "update": {
          "x": {
            "scale": "page_group_load_time_scale",
            "field": "page_timer"
          }
        }
      }
    },
    {
      "name": "page_group_original_load_time_lozenge_mark",
      "type": "rect",
      "from": {
        "data": "page_group_data"
      },
      "encode": {
        "enter": {
          "yc": {
            "signal": "scale('page_group_scale',datum.page_group) + (bandwidth('page_group_scale') * 0.5)"
          },
          "height": {
            "scale": "page_group_scale",
            "band": 0.8
          },
          "width": {
            "value": 9
          },
          "cornerRadius": {
            "value": 5
          },
          "fill": {
            "value": "hsla(210, 0%, 100%, 0)"
          },
          "stroke": {
            "value": "hsla(210, 50%, 75%, 1)"
          },
          "strokeWidth": {
            "value": 1
          },
          "strokeDash": { "value": [6,3]}
        },
        "update": {
          "x": {
            "signal": "scale('page_group_load_time_scale',datum.page_timer) + 50"
          },
          "tooltip": {
            "signal": "item"
          }
        }
      }
    },
    {
      "name": "page_group_original_load_time_line_mark",
      "type": "rule",
      "from": {
        "data": "page_group_data"
      },
      "encode": {
        "enter": {
          "y": {
            "signal": "scale('page_group_scale',datum.page_group) + (bandwidth('page_group_scale') * 0.5)"
          },
          "stroke": {
            "value": "hsla(210, 50%, 75%, 1)"
          },
          "strokeWidth": {
            "value": 1
          },
          "strokeDash": { "value": [6,3]}
        },
        "update": {
          "x": {
            "signal": "scale('page_group_load_time_scale',datum.page_timer) + 50"
          },
          "x2": {
            "signal": "scale('page_group_load_time_scale',datum.page_timer) + 9"
          },
          "tooltip": {
            "signal": "scale('page_group_original_load_time_lozenge_mark','x')"
          }
        }
      }
    },
    {
      "name": "page_group_original_load_time_arrow_mark",
      "type": "symbol",
      "from": {
        "data": "page_group_data"
      },
      "encode": {
        "enter": {
          "angle": {
            "value": 0
          },
          "size": {
          "value": 130
          },
          "shape": {
            "value": "triangle-left"
          },
          "y": {
            "signal": "scale('page_group_scale',datum.page_group) + (bandwidth('page_group_scale') * 0.5)"
          },
          "fill": {
            "value": "hsla(210, 50%, 75%, 1)"
          }
        },
        "update": {
          "x": {
            "signal": "scale('page_group_load_time_scale',datum.page_timer) + 15"
          }
        }
      }
    },
    {
      "type": "text",
      "encode": {
        "enter": {
          "align": {
            "value": "center"
          },
          "baseline": {
            "value": "bottom"
          },
          "fill": {
            "value": "#333"
          }
        },
        "update": {
          "text": {
            "signal": "tooltip.amount"
          },
          "fillOpacity": [
            {
              "test": "datum === tooltip",
              "value": 0
            },
            {
              "value": 1
            }
          ]
        }
      }
    }
  ]
}